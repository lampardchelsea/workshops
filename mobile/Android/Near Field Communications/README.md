Near Field Communications overview
==================================
* Close-range radio communication - 4 cm effective range
* Effective for small bursts of data
* Comes in 'active' and 'passive' forms, typically as in an active mobile device and a passive (sticker) tag  
* Expected smart-phone penetration of 50% by 2013

Workshop targets
=========================
* Learn some NDEF format basics
    * Compose NDEF messages
    * Write to tag using a tool app
* Programmatically read NDEF messages into an Android device with NFC support
* Programmatically compose and write NDEF messages
* Send NDEF messages directly between two devices
* Read application directory of Mifare Desfire EV1 cards

Prerequsistis 
=========================
You must know Android development. If you require help with the basics, we will not have the time to help you.

Requirements - bring this
=========================
* A computer (PC, Mac or Linux)
* An NFC-enabled device (Android 4.0 or higher)
    * Install Android application '[NFC Developer](https://play.google.com/store/apps/details?id=com.antares.nfc)' from Android Play
* An USB cable to connect computer and device
* Eclipe with Android SDK installed
    * Install [NFC plugin](http://nfc-eclipse-plugin.googlecode.com) from update site http://nfc-eclipse-plugin.googlecode.com/git/nfc-eclipse-plugin-feature/update-site/ 
* Check out this (https://github.com/skjolber/Fagmote.git) Git repository. Alternatively, [download zip](https://github.com/skjolber/Fagmote/downloads). Add the projects to your workspace.

Note that Eclipse is merely required for the NDEF editor, so you can still use your favorite editor for the rest of the tasks. Just make sure the base project imports successfully.

Task 1 - Create new NDEF message and write to tag using tool
=========================
### a. Open base project
Open imported project 'HelloWorldNFC Base'. 

### b. Create new NDEF file
Create a new file in the root of the project using New -> Other -> Near Field Communications -> NDEF File.

Hint: NDEF is a data format used in tags.
### c. Add an Android Application Record
1. Read online documentation about [Android Application Records](http://developer.android.com/guide/topics/nfc/nfc.html#aar).
2. Create an Android Application Record with package name 'no.java.schedule' using the NDEF editor.

Hint: Open NDEF file and right-click on the table.
### d. Write the NDEF message to a tag.
You now have an NDEF message consisting of a single record. Start the 'NFC Developer' application:

1. Scan the custom QR code generated by the NDEF editor. 
2. Write by holding a tag to the back of the device.

Hint: If nothing happens, make sure you are holding the tag in the center of the backside of the phone (NFC range is only 4 cm ;-))
Hint: If get tag write IOException, try scanning again a bit slower.
### e. Try out the newly created tag
Close 'NFC Developer' application and navigate to the home screen. Make sure your Android device is online. What happens when you scan the tag?

Hint: If you do not already have an application with identifier '[no.java.schedule](https://play.google.com/store/search?q=no.java.schedule&c=apps)' installed, Android will search for it at [Google Play](https://play.google.com/store).

Task 2 - Discover tag - Hello NFC tag
===========================
### a. Launch Hello World application via NFC
Launch (run) the empty 'HelloWorldNFC Base' project, so that it gets installed on your device. Then edit the tag from the previuos task so that the Android Application package is __'com.helloworld.nfc'__.
### b. Change Hello World text by scanning a tag
We want to receieve NFC messages when our application is showing on the screen. 

1. Add NFC [permissions](http://developer.android.com/guide/topics/nfc/nfc.html#manifest) in AndroidMainfest.xml:

        <!-- Near field communications permissions -->
        <uses-permission android:name="android.permission.NFC" />
        <uses-feature android:name="android.hardware.nfc" android:required="true" />

2. Initialize NFC [foreground mode](http://developer.android.com/guide/topics/nfc/advanced-nfc.html#foreground-dispatch) in the Hello World activity:

    	@Override
		public void onCreate(Bundle savedInstanceState) {
        		super.onCreate(savedInstanceState);
        		setContentView(R.layout.main);
            	// initialize NFC
        		nfcAdapter = NfcAdapter.getDefaultAdapter(this);
        		nfcPendingIntent = PendingIntent.getActivity(this, 0, new Intent(this, this.getClass()).addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP), 0);
	    	}

	
3. Call enable/disable foreground mode from onResume() and onPause() in the Hello World activity:

		public void enableForegroundMode() {
		    	Log.d(TAG, "enableForegroundMode");
                // foreground mode gives the current active application priority for reading scanned tags
        		IntentFilter tagDetected = new IntentFilter(NfcAdapter.ACTION_TAG_DISCOVERED); // filter for tags
        		IntentFilter[] writeTagFilters = new IntentFilter[] {tagDetected};
        		nfcAdapter.enableForegroundDispatch(this, nfcPendingIntent, writeTagFilters, null);
		}
		public void disableForegroundMode() {
			Log.d(TAG, "disableForegroundMode");
			nfcAdapter.disableForegroundDispatch(this);
		}

4. Change title to 'Hello NFC!' when a tag is scanned:
Add

    	@Override
    	public void onNewIntent(Intent intent) { // this method is called when an NFC tag is scanned
        	Log.d(TAG, "onNewIntent");
	        if (NfcAdapter.ACTION_TAG_DISCOVERED.equals(intent.getAction())) {
	            Log.d(TAG, "A tag was scanned!");
	            TextView textView = (TextView) findViewById(R.id.title);
	            textView.setText("Hello NFC tag!");
                vibrate(); // signal detected tag :-)
	        }
        }    
Verify functionality: First start the application. Then scan the tag and see what happens.
    
### c. Detect app launch via NFC tag
So far we have only detected the tag after the app was started. To detect whenever the app itself is launched by scanning our tag, add

        <intent-filter>
            <action android:name="android.nfc.action.NDEF_DISCOVERED" />
            <category android:name="android.intent.category.DEFAULT" />
            <data android:scheme="vnd.android.nfc" />
		</intent-filter>   
and append the onCreate(..) method with

    	if(getIntent().hasExtra(NfcAdapter.EXTRA_TAG)) {
	        TextView textView = (TextView) findViewById(R.id.title);
	        textView.setText("Hello lauch from NFC tag!");            
            vibrate(); // signal detected tag :-)
		}

Are you able to make the app show the new message?

Hint: Relaunch the app and close it. Then scan the tag from the home screen. 

Task 3 - Read and analyze tag payload
=============================
### a. Obtain tag NDEF payload
Check for [NDEF](http://developer.android.com/guide/topics/nfc/nfc.html) messages in method onNewIntent(..) using 

	Parcelable[] messages = intent.getParcelableArrayExtra(NfcAdapter.EXTRA_NDEF_MESSAGES);
	if (messages != null) {	
		Log.d(TAG, "Found " + messages.length + " NDEF messages");
	}

Verify that messages appear in the log.
### b. Get the NdefMessage.
Cast the first messages element into the Android class NdefMessage:

    NdefMessage ndefMessage = (NdefMessage)messages[0];
    
and log the number of NdefRecords within the ndefMessage. How does the NdefRecord class compare to the NDEF records we saw in the NDEF editor in task 1?

### c. Parse NdefMessage using [NDEF Tools for Android](http://code.google.com/p/ndef-tools-for-android/)

Parse ndefMessage from previous task into Records using

	// parse to high-level records
    try {
        List<Record> records = new Message(ndefMessage);

        Log.d(TAG, "Found " + records.size() + " records in message");
    } catch (Exception e) {
        Log.e(TAG, "Problem parsing message", e);
    }

Verify that the expected messages appear in the log.
### d. Determine which NDEF records are present on the tag.
Iterate of the parsed record(s) and investigate their type and contents.

    for(int k = 0; k < records.size(); k++) {
        Record record = records.get(k);
    	
        Log.d(TAG, " Record #" + k + " is of class " + record.getClass().getName());
        
        // TODO: add breakpoint or log statement and inspect record. 
    }

Did your tag contain the expected content?

### e. Get the tag id
The tag id can be a useful attribute. Log the tag id by adding a call to

    protected void printTagId(Intent intent) {
		if(intent.hasExtra(NfcAdapter.EXTRA_ID)) {
			byte[] byteArrayExtra = intent.getByteArrayExtra(NfcAdapter.EXTRA_ID);
			
			Log.d(TAG, "Tag id is " + toHexString(byteArrayExtra));
		}
	}

Task 4 - Compose and write tag payload
=======================================
Open imported project 'HelloWorldNFC Base'. 
### a. Compose an NDEF message using [NDEF Tools for Android](http://code.google.com/p/ndef-tools-for-android/)
    public Message composeMessage(String text) {
		Log.d(TAG, "createMessage");

		Message message = new Message(); // ndeftools ndef message
		
		// add an android application record
		AndroidApplicationRecord aar = new AndroidApplicationRecord("com.helloworld.nfc");
		message.add(aar);
		
		// add a text record
		TextRecord record = new TextRecord(text);
		message.add(record);

		return message;
	}

### b. Write the message when tag is scanned
1. Convert Message to ndefMessage
We need to convert our high-level objects to the Android native low-level equivalent.

        Message composedMessage = composeMessage("1);
        NdefMessage composedMessageNdefMessage = composedMessage.getNdefMessage();

2. Write to tag
Add the following code. Call the method from onNewIntent() if a tag is detected.

        public boolean write(NdefMessage rawMessage, Intent intent) {
		    Tag tag = intent.getParcelableExtra(NfcAdapter.EXTRA_TAG);
            Ndef ndef = Ndef.get(tag);
            if(ndef != null) {
            	try {
            		Log.d(TAG, "Write formatted tag");
            		ndef.connect();
            		if (!ndef.isWritable()) {
            			Log.d(TAG, "Tag is not writeable");
            		    return false;
            		}
            		if (ndef.getMaxSize() < rawMessage.toByteArray().length) {
            			Log.d(TAG, "Tag size is too small, have " + ndef.getMaxSize() + ", need " + rawMessage.toByteArray().length);
            		    return false;
            		}
            		ndef.writeNdefMessage(rawMessage);
            		return true;
            	} catch (Exception e) {
            		Log.d(TAG, "Problem writing to tag", e);
                } finally {
                	try {
    					ndef.close();
    				} catch (IOException e) {
    					// ignore
    				}
                }
            } else {
    			Log.d(TAG, "Write to an unformatted tag not implemented");
    		}
    	    return false;
    	}

3. Update gui text on write success or failure.

        if(write(composedMessageNdefMessage, intent)) {
            Log.d(TAG, "Write success!");
	        TextView textView = (TextView) findViewById(R.id.title);
	        textView.setText("Write success!");
        } else {
        	Log.d(TAG, "Write failure!");
	        TextView textView = (TextView) findViewById(R.id.title);
	        textView.setText("Write failure!");
        }

then verify that the code is working. Do you see the new Text Record in the log the second time you scan the tag?

### c. Increment the integer stored in the Text Record on tag scan
In the onNewIntent() method

1. Detect og read the NDEF message and filter out the Text Record.
2. Get the Text Record text, parse and increment the number
3. Compose a new NDEF message and write it to the tag
4. Update the GUI with the resulting number

Task 5 - device to device communication: Android Beam
=====================================================
Use [Android Beam](http://developer.android.com/guide/topics/nfc/nfc.html#p2p) to exchange information between two devices.

### a. Register push message callback interface 
Read about the [NfcAdapter.CreateNdefMessageCallback](http://developer.android.com/reference/android/nfc/NfcAdapter.CreateNdefMessageCallback.html) interface and register callback in the activity 'onCreate()' method using 

        // Register Android Beam callback
        nfcAdapter.setNdefPushMessageCallback(this, this);

### b. Compose push message  
Implement method 'createNdefMessage(..) - compose the NdefMessage to be pushed:

    	Log.d(TAG, "createNdefMessage");

		Message message = new Message(); // ndeftools ndef message
		
		// add an android application record
		AndroidApplicationRecord aar = new AndroidApplicationRecord("com.helloworld.nfc");
		message.add(aar);

		// create external type record to be pushed
		ExternalTypeRecord record = new GenericExternalTypeRecord("com.my.data", "myDataType", "This is my magic payload".getBytes(Charset.forName("UTF-8")));
		message.add(record);
		
		// encode one or more record to NdefMessage
		return message.getNdefMessage();

### c. Push message between two devices
Hold two devices together and see what happens. When a is message pushed from one NFC device to another?

### d. Read pushed message (on the receiver side)
Are you able to filter out the right external type record on the reciever side?
Hint 1: A pushed NDEF message can be read the same was as a tag
Hint 2: The Android Application Record is also an External Type record.

### e. Post push message notification
Use the [NfcAdapter.OnNdefPushCompleteCallback](http://developer.android.com/reference/android/nfc/NfcAdapter.OnNdefPushCompleteCallback.html) interface to show a notification when a message is pushed using Android Beam.
First register callback in 'onCreate(..)'

        // Register callback to listen for message-sent success 
        nfcAdapter.setOnNdefPushCompleteCallback(this, this);

Then implement the 'onNdefPushComplete(..)' method:
    
        // Handle push success 
	    @Override
    	public void onNdefPushComplete(NfcEvent nfcEvent) {
        	Log.d(TAG, "onNdefPushComplete");
		
    		runOnUiThread(new Runnable() {
	    		public void run() {
    	            TextView textView = (TextView) findViewById(R.id.title);
    	            textView.setText("Message beamed!");
    			}	
		    });
	    }



Verify that everything is working by holding two phones together. Reflect over the user-friendliness of transferring a lot of data holding two devices together in this way - what would be a more practical approach in such a scenario?

Task 6 - Mifare Desfire EV1 intro
==========================
So far we have relied on the Android NFC subsystem to abstract away the actual NFC tag communication details. Lets look at the [Mifare Desfire EV1 card](http://www.nxp.com/products/identification_and_security/smart_card_ics/mifare_smart_card_ics/mifare_desfire/).

### a. Open base project
Open imported project 'HelloWorldNFC Desfire Base'. Open the MainActivity class.

### b. Identify Desfire EV1 tag type. 
Android supplies multiple technology-specific classes for low-level access, depending on the tag type and its contents. The [IsoDep](http://developer.android.com/reference/android/nfc/tech/IsoDep.html) class is responsible for interacting with Desfire EV1 cards. 

Add the following code to the nfcIntentDetected(..) method:

	Tag tag = intent.getParcelableExtra(NfcAdapter.EXTRA_TAG);
	if(tag != null) {
		IsoDep isoDep = null;
		String[] techList = tag.getTechList();
		for (String tech : techList) {
			Log.d(TAG, "Tech " + tech);

			if (tech.equals(android.nfc.tech.IsoDep.class.getName())) {
				isoDep = android.nfc.tech.IsoDep.get(tag);
			}
		}
		if(isoDep != null) {
			Log.d(TAG, "Detected Desfire tag");
	        TextView textView = (TextView) findViewById(R.id.title);
	        textView.setText("Desfire tag!");
		} else {
			Log.d(TAG, "Did not detect a Desfire tag");
            
	        TextView textView = (TextView) findViewById(R.id.title);
	        textView.setText("Unknown tag!");
		}
	}

### c. Read tag metadata
Use the __DesfireReader__ class to read some basic tag metadata:

	try {
		isoDep.connect();

		DesfireReader reader = new DesfireReader(isoDep);

		VersionInfo versionInfo = reader.getVersionInfo();
		Log.d(TAG, "Tag ID " + toHexString(versionInfo.getUid()));
		Log.d(TAG, "Hardware version " + versionInfo.getHardwareVersion() + ", software version " + versionInfo.getSoftwareVersion());
		Log.d(TAG, "Hardware capacity " + versionInfo.getHardwareStorageSize() + ", software capacity " + versionInfo.getSoftwareStorageSize());
	} catch (Exception e) {
		Log.d(TAG, "Problem accessing Desfire tag", e);
	} finally {
		try {
			isoDep.close();
		} catch (IOException e) {
			// ignore
		}
	}			

What is the tag storage capacity for this tag?

### d. Read tag application directory
Desfire EV1 files have a more structured nature that most tags. The tag storage area consists of a directory of Applications and then Files within each Application. The Add

	int[] applicationDirectory = reader.getApplicationDirectory();
	Log.d(TAG, "Read " + applicationDirectory.length + " apps");

	for (int i = 0; i < applicationDirectory.length; i++) {
		reader.selectApplication(applicationDirectory[i]);
		int[] fileList = reader.getFiles();
		Log.d(TAG, "App " + Integer.toHexString(applicationDirectory[i]) + " at index " + i + " has " + fileList.length + " files");
	}

### e. Read the files within each application
Add 

	for (int k = 0; k < fileList.length; k++) {
		DesfireFileSettings fileSettings = reader.getFileSettings(fileList[k]);

		Log.d(TAG, "Read file " + k + " settings " + fileSettings.getClass().getSimpleName() + " 0x" + Integer.toHexString(fileList[k]) + " " + fileSettings.getFileTypeName());
        
        // print file read and writes access
		if(fileSettings.freeReadAccess()) {
			Log.d(TAG, "File " + k + " is readable");
		}
		if(fileSettings.freeWriteAccess()) {
			Log.d(TAG, "File " + k + " is writable");
		}

		byte[] fileContents = reader.readFile(fileList[k]);

		Log.d(TAG, "Read " + fileContents.length + " bytes for file " + k);
	}

Does the fileContents byte array contain any familiar data?
Hint: Create a String from the byte-array.

What other highly desirable functions than multi-Application support does the Desfire EV1 cards have?

Bonus task - more NDEF record types
===================================
### a. How would you make NFC support optional?
Not all devices have NFC chips (yet)
### b. What are the tag classes and their storage capactiy?
What are the disadvantage of larger storage capacities?
### c. Create more record types
1. Create well-known URI record.
2. Create Mime Record.
3. Create your own External type Record.



